<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>将棋の殿堂</title>
    <link rel="stylesheet" href="style.css?v=20251031-a">
</head>
<body>
<header>
<p><a href="https://ulti-shogi.github.io/beta-open/index.html">TOPページに戻る</a></>
</header>
  <main>
<section>
  <!-- ① 並び替えカテゴリ -->
  <label for="">並び替えカテゴリー</label>
  <select name="">
    <option value="age">年齢系</option>
    <option value="promote-age">昇段年齢</option>
    <option value="promote-gap">昇段区間日数</option>
    <option value="career">キャリア長</option>
  </select>

  <!-- ② 並び替え項目（カテゴリに応じてJSで中身を差し替える想定） -->
  <label for="">並び替え項目</label>
  <select name="">
    <!-- JSでoptionを挿入する -->
  </select>

  <!-- ③ 昇順・降順 -->
  <p>並び順</p>
  <label><input type="radio" name="order" value="asc" checked> 昇順</label>
  <label><input type="radio" name="order" value="desc"> 降順</label>

  <!-- ④ クイックプリセット（よく使う並び替え） -->
  <p>よく使う並び替え</p>
  <button type="button">四段昇段年齢（若い順）</button>
  <button type="button">現役期間（長い順）</button>
  <button type="button">四→九 最短</button>
  <button type="button">現在の年齢（若い順）</button>

  <!-- ⑤ 状態フィルタ -->
  <p>状態で絞り込み</p>
  <label><input type="checkbox" name="status" value="active" checked> 現役</label>
  <label><input type="checkbox" name="status" value="retired" checked> 引退</label>
  <label><input type="checkbox" name="status" value="dead" checked> 故人</label>

  <!-- ⑥ 最終段位フィルタ -->
  <p>最終段位で絞り込み</p>
  <label><input type="checkbox" name="rank" value="title" checked> 称号</label>
  <label><input type="checkbox" name="rank" value="4d" checked> 四段</label>
  <label><input type="checkbox" name="rank" value="5d" checked> 五段</label>
  <label><input type="checkbox" name="rank" value="6d" checked> 六段</label>
  <label><input type="checkbox" name="rank" value="7d" checked> 七段</label>
  <label><input type="checkbox" name="rank" value="8d" checked> 八段</label>
  <label><input type="checkbox" name="rank" value="9d" checked> 九段</label>

  <!-- ⑦ 件数指定 -->
  <p>表示件数</p>
  <input type="number" name="" value="10" inputmode="numeric">
  <button type="button">全件（空欄）</button>

  <!-- ⑧ 検索ボタン -->
  <p><button type="button">この条件で表示</button></p>
</section>

<table>
  <thead></thead>
    <tbody></tbody>
</table>

<div class="free">
  <h3>自由欄</h3>
  <p>補足情報など自由に書き込む。</p>
      </div>

  </main>
  <footer>フッター</footer>

<script>
// =========================================
// profile.html 用スクリプト
// 方針：
// ① CSVは「日付だけ」の原本とし、ここで派生値を全部計算
// ② section内のUIは、すでにある順番の要素をquerySelectorで拾う
// ③ 列は「列名（ヘッダ）」で参照し、列位置には依存しない
// ④ テーブルはページに1つだけある前提で描画する
// ⑤ 欠損はnullにしてソート時は末尾送り
// =========================================

// CSVファイル名（profile.htmlと同じ場所に置いておく想定）
const CSV_URL = 'profile.csv';

// 今日の日付（JST）をロード時に固定しておく
const today = (function() {
  const d = new Date();
  // JSTに寄せる（ブラウザ環境では大抵JSTになっているが、念のためUTC補正はせず固定とする）
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
})();

// CSVを読み込んで配列にする
fetch(CSV_URL)
  .then(res => res.text())
  .then(text => {
    const data = parseCSV(text);
    // 派生値を付与したデータを保持
    window.__PROFILE_DATA__ = data.map(row => enrichRow(row));
    setupUI();
    // 初期表示：四段昇段年齢（若い順）を想定
    applyPreset('4d-young');
  })
  .catch(err => {
    console.error('CSV読込に失敗しました:', err);
  });

// -----------------------------------------
// CSVパーサ（非常に単純な想定：カンマ区切り・ダブルクォートなし前提）
// 列名は1行目にあるものをそのままキーにする
// -----------------------------------------
function parseCSV(csvText) {
  const lines = csvText.trim().split(/\r?\n/);
  if (!lines.length) return [];
  const header = lines[0].split(',');
  const rows = [];

  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const cols = lines[i].split(',');
    const obj = {};
    header.forEach((h, idx) => {
      obj[h.trim()] = (cols[idx] || '').trim();
    });
    rows.push(obj);
  }
  return rows;
}

// -----------------------------------------
// 日付文字列(YYYY-MM-DD) → Date(UTC0時) に安全に変換
// 欠損や不正値はnullで返す
// -----------------------------------------
function toDateSafe(str) {
  if (!str) return null;
  // YYYY-MM-DD 以外は弾く
  const m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  const y = Number(m[1]);
  const mo = Number(m[2]);
  const d = Number(m[3]);
  // UTCの0時に固定しておくことで日付差分が安定する
  return new Date(Date.UTC(y, mo - 1, d));
}

// -----------------------------------------
// 日数差を出す（startとendはDate or null）
// nullが混じっていたらnullで返す
// -----------------------------------------
function diffDays(start, end) {
  if (!start || !end) return null;
  const ms = end.getTime() - start.getTime();
  return Math.floor(ms / 86400000); // 1000*60*60*24
}

// -----------------------------------------
// 派生値を付与する
// row: CSV 1行ぶんのオブジェクト（列名でアクセス）
// ここで「現在年齢」「各段昇段年齢」「区間日数」「現役期間」「最終段位」などを付ける
// -----------------------------------------
function enrichRow(row) {
  // 列名はCSVに合わせてここで拾う
  // 想定列：
  // 「棋士名」「生年月日」「四段昇段日」「五段昇段日」「六段昇段日」「七段昇段日」「八段昇段日」「九段昇段日」「引退日」「没年月日」
  const birth = toDateSafe(row['生年月日']);
  const p4 = toDateSafe(row['四段昇段日']);
  const p5 = toDateSafe(row['五段昇段日']);
  const p6 = toDateSafe(row['六段昇段日']);
  const p7 = toDateSafe(row['七段昇段日']);
  const p8 = toDateSafe(row['八段昇段日']);
  const p9 = toDateSafe(row['九段昇段日']);
  const retired = toDateSafe(row['引退日']);
  const died = toDateSafe(row['没年月日']);

  // 現在年齢 or 没年齢（日数）
  let age_days_now = null;
  if (birth) {
    if (died) {
      age_days_now = diffDays(birth, died);
    } else {
      age_days_now = diffDays(birth, today);
    }
  }

  // 各段到達時の年齢（日数）
  const age_days_at_4d = (birth && p4) ? diffDays(birth, p4) : null;
  const age_days_at_5d = (birth && p5) ? diffDays(birth, p5) : null;
  const age_days_at_6d = (birth && p6) ? diffDays(birth, p6) : null;
  const age_days_at_7d = (birth && p7) ? diffDays(birth, p7) : null;
  const age_days_at_8d = (birth && p8) ? diffDays(birth, p8) : null;
  const age_days_at_9d = (birth && p9) ? diffDays(birth, p9) : null;

  // 区間日数（昇段にかかった日数）
  const days_4to5 = (p4 && p5) ? diffDays(p4, p5) : null;
  const days_5to6 = (p5 && p6) ? diffDays(p5, p6) : null;
  const days_6to7 = (p6 && p7) ? diffDays(p6, p7) : null;
  const days_7to8 = (p7 && p8) ? diffDays(p7, p8) : null;
  const days_8to9 = (p8 && p9) ? diffDays(p8, p9) : null;

  // 現役期間（四段昇段日〜引退日 or 今日）
  let career_days = null;
  if (p4) {
    if (retired) {
      career_days = diffDays(p4, retired);
    } else {
      career_days = diffDays(p4, today);
    }
  }

  // 状態（現役・引退・故人）
  // 優先順位：没あり→故人、没なし＆引退日あり→引退、上記以外→現役
  let status = 'active';
  if (died) {
    status = 'dead';
  } else if (retired) {
    status = 'retired';
  }

  // 最終段位（九→…→四→称号）
  let final_rank = '称号';
  if (p9) {
    final_rank = '9d';
  } else if (p8) {
    final_rank = '8d';
  } else if (p7) {
    final_rank = '7d';
  } else if (p6) {
    final_rank = '6d';
  } else if (p5) {
    final_rank = '5d';
  } else if (p4) {
    final_rank = '4d';
  } else {
    final_rank = 'title'; // 生年ありだが段がない場合を称号扱い
  }

  return Object.assign({}, row, {
    _birth: birth,
    _p4: p4,
    _p5: p5,
    _p6: p6,
    _p7: p7,
    _p8: p8,
    _p9: p9,
    _retired: retired,
    _died: died,
    age_days_now,
    age_days_at_4d,
    age_days_at_5d,
    age_days_at_6d,
    age_days_at_7d,
    age_days_at_8d,
    age_days_at_9d,
    days_4to5,
    days_5to6,
    days_6to7,
    days_7to8,
    days_8to9,
    career_days,
    status,
    final_rank
  });
}

// -----------------------------------------
// UI の初期化
// section内の要素は、並び替えカテゴリ→並び替え項目→ラジオ→プリセット→…の順で追加済みなので、
// querySelectorAllで順番に取る
// -----------------------------------------
function setupUI() {
  const section = document.querySelector('section');
  if (!section) return;

  const selects = section.querySelectorAll('select');
  const buttons = section.querySelectorAll('button');
  const radios = section.querySelectorAll('input[type="radio"][name="order"]');
  const statusChecks = section.querySelectorAll('input[type="checkbox"][name="status"]');
  const rankChecks = section.querySelectorAll('input[type="checkbox"][name="rank"]');
  const numberInput = section.querySelector('input[type="number"]');

  // セレクトは2つある前提
  const selCategory = selects[0];
  const selMetric = selects[1];

  // ボタンは
  // 0〜3: プリセット
  // 4: 全件（空欄）
  // 5: この条件で表示
  const presetButtons = [buttons[0], buttons[1], buttons[2], buttons[3]];
  const allButton = buttons[4];
  const searchButton = buttons[5];

  // カテゴリ選択でメトリックを更新
  selCategory.addEventListener('change', () => {
    fillMetricOptions(selCategory, selMetric);
  });

  // プリセットボタン
  presetButtons[0].addEventListener('click', () => applyPreset('4d-young'));
  presetButtons[1].addEventListener('click', () => applyPreset('career-long'));
  presetButtons[2].addEventListener('click', () => applyPreset('4to9-short')); // 今は後で実装でもOK
  presetButtons[3].addEventListener('click', () => applyPreset('age-young'));

  // 全件ボタン
  allButton.addEventListener('click', () => {
    if (numberInput) numberInput.value = '';
  });

  // 検索ボタン
  searchButton.addEventListener('click', () => {
    const current = collectConditions();
    const filtered = filterData(window.__PROFILE_DATA__, current);
    const sorted = sortData(filtered, current);
    const limited = limitData(sorted, current);
    renderTable(limited);
  });

  // 初回メトリックの注入
  fillMetricOptions(selCategory, selMetric);

  // 条件を一度集めて初期描画しておく（CSV読み込み直後のapplyPresetでも描画するので2重でもOK）
  const initialCond = collectConditions();
  const initialFiltered = filterData(window.__PROFILE_DATA__ || [], initialCond);
  const initialSorted = sortData(initialFiltered, initialCond);
  const initialLimited = limitData(initialSorted, initialCond);
  renderTable(initialLimited);

  // 条件を集める関数（スコープ内で使う）
  function collectConditions() {
    // 並び順
    let order = 'asc';
    radios.forEach(r => {
      if (r.checked) order = r.value;
    });
    // 状態
    const statusValues = [];
    statusChecks.forEach(c => {
      if (c.checked) statusValues.push(c.value);
    });
    // 段位
    const rankValues = [];
    rankChecks.forEach(c => {
      if (c.checked) rankValues.push(c.value);
    });

    return {
      category: selCategory.value,
      metric: selMetric.value,
      order,
      statuses: statusValues,
      ranks: rankValues,
      limit: numberInput && numberInput.value ? Number(numberInput.value) : null
    };
  }
}

// -----------------------------------------
// カテゴリに応じて並び替え項目を詰める
// ここは「無いデータは出さない」実装にしてもいいが、
// まずは固定で入れて、ソート時にnullは後ろへ送る。
// -----------------------------------------
function fillMetricOptions(selCategory, selMetric) {
  const cat = selCategory.value;
  selMetric.innerHTML = '';
  let opts = [];

  if (cat === 'age') {
    opts = [
      { value: 'age_days_now', label: '現在の年齢（日数）' },
      { value: 'age_days_dead', label: '没年齢（日数）' } // 実体はage_days_nowと同じ扱いだが名前だけ分けたい場合
    ];
  } else if (cat === 'promote-age') {
    opts = [
      { value: 'age_days_at_4d', label: '四段昇段年齢（日数）' },
      { value: 'age_days_at_5d', label: '五段昇段年齢（日数）' },
      { value: 'age_days_at_6d', label: '六段昇段年齢（日数）' },
      { value: 'age_days_at_7d', label: '七段昇段年齢（日数）' },
      { value: 'age_days_at_8d', label: '八段昇段年齢（日数）' },
      { value: 'age_days_at_9d', label: '九段昇段年齢（日数）' }
    ];
  } else if (cat === 'promote-gap') {
    opts = [
      { value: 'days_4to5', label: '四→五への所要日数' },
      { value: 'days_5to6', label: '五→六への所要日数' },
      { value: 'days_6to7', label: '六→七への所要日数' },
      { value: 'days_7to8', label: '七→八への所要日数' },
      { value: 'days_8to9', label: '八→九への所要日数' }
    ];
  } else if (cat === 'career') {
    opts = [
      { value: 'career_days', label: '現役期間（日数）' }
    ];
  }

  opts.forEach(o => {
    const op = document.createElement('option');
    op.value = o.value;
    op.textContent = o.label;
    selMetric.appendChild(op);
  });
}

// -----------------------------------------
// プリセット適用
// -----------------------------------------
function applyPreset(name) {
  const section = document.querySelector('section');
  if (!section) return;
  const selects = section.querySelectorAll('select');
  const radios = section.querySelectorAll('input[type="radio"][name="order"]');
  const numberInput = section.querySelector('input[type="number"]');

  const selCategory = selects[0];
  const selMetric = selects[1];

  // デフォ：昇順
  let order = 'asc';
  let cat = 'promote-age';
  let metric = 'age_days_at_4d';

  if (name === '4d-young') {
    cat = 'promote-age';
    metric = 'age_days_at_4d';
    order = 'asc';
  } else if (name === 'career-long') {
    cat = 'career';
    metric = 'career_days';
    order = 'desc';
  } else if (name === '4to9-short') {
    // 今回は昇段区間の一例として四→五を短い順にする
    cat = 'promote-gap';
    metric = 'days_4to5';
    order = 'asc';
  } else if (name === 'age-young') {
    cat = 'age';
    metric = 'age_days_now';
    order = 'asc';
  }

  selCategory.value = cat;
  fillMetricOptions(selCategory, selMetric);
  selMetric.value = metric;

  radios.forEach(r => {
    r.checked = (r.value === order);
  });

  // 初期は10件に戻す
  if (numberInput) numberInput.value = 10;

  // 再描画
  const data = window.__PROFILE_DATA__ || [];
  const cond = {
    category: cat,
    metric: metric,
    order: order,
    statuses: Array.from(section.querySelectorAll('input[type="checkbox"][name="status"]:checked')).map(c => c.value),
    ranks: Array.from(section.querySelectorAll('input[type="checkbox"][name="rank"]:checked')).map(c => c.value),
    limit: numberInput && numberInput.value ? Number(numberInput.value) : null
  };
  const filtered = filterData(data, cond);
  const sorted = sortData(filtered, cond);
  const limited = limitData(sorted, cond);
  renderTable(limited);
}

// -----------------------------------------
// フィルタリング
// -----------------------------------------
function filterData(data, cond) {
  return data.filter(row => {
    // 状態フィルタ
    if (cond.statuses && cond.statuses.length) {
      if (!cond.statuses.includes(row.status)) {
        return false;
      }
    }
    // 最終段位フィルタ
    if (cond.ranks && cond.ranks.length) {
      if (!cond.ranks.includes(row.final_rank)) {
        return false;
      }
    }
    return true;
  });
}

// -----------------------------------------
// ソート
// cond.metric をキーにして昇降順
// null 値は常に末尾
// 同値は 生年月日 → 棋士番号 でタイブレーク
// -----------------------------------------
function sortData(data, cond) {
  const key = cond.metric;
  const order = cond.order === 'desc' ? -1 : 1;

  const copied = data.slice();
  copied.sort((a, b) => {
    const va = a[key];
    const vb = b[key];

    // nullは末尾
    const aIsNull = (va === null || typeof va === 'undefined' || va === '');
    const bIsNull = (vb === null || typeof vb === 'undefined' || vb === '');
    if (aIsNull && bIsNull) {
      // 生年月日で見てみる
    } else if (aIsNull) {
      return 1;
    } else if (bIsNull) {
      return -1;
    } else {
      if (va !== vb) {
        return (va - vb) * order;
      }
    }

    // 同値時は生年月日（古い方を先）
    const ba = a['_birth'];
    const bb = b['_birth'];
    if (ba && bb) {
      if (ba.getTime() !== bb.getTime()) {
        return (ba.getTime() - bb.getTime());
      }
    }

    // さらに同値なら棋士番号（数値にできたら数値で）
    const na = Number(a['棋士番号'] || 0);
    const nb = Number(b['棋士番号'] || 0);
    return na - nb;
  });

  return copied;
}

// -----------------------------------------
// 件数制限
// -----------------------------------------
function limitData(data, cond) {
  if (!cond.limit || isNaN(cond.limit)) return data;
  return data.slice(0, cond.limit);
}

// -----------------------------------------
// テーブル描画
// ページにある最初の<table>に出力する
// thead/tbodyが既にあるならtbodyを差し替えるだけでもOKだが、
// ここではtbodyを毎回作る
// -----------------------------------------
function renderTable(data) {
  const table = document.querySelector('table');
  if (!table) return;

  // theadが無ければ作る（1回だけ）
  if (!table.querySelector('thead')) {
    const thead = document.createElement('thead');
    const tr = document.createElement('tr');
    ['順位', '棋士名', '段位/称号', '生年月日', '四段', '五段', '六段', '七段', '八段', '九段', '状態', '指標値'].forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      tr.appendChild(th);
    });
    thead.appendChild(tr);
    table.appendChild(thead);
  }

  // tbody差し替え
  let tbody = table.querySelector('tbody');
  if (!tbody) {
    tbody = document.createElement('tbody');
    table.appendChild(tbody);
  }
  tbody.innerHTML = '';

  data.forEach((row, idx) => {
    const tr = document.createElement('tr');

    const tdRank = document.createElement('td');
    tdRank.textContent = idx + 1;
    tr.appendChild(tdRank);

    const tdName = document.createElement('td');
    tdName.textContent = row['棋士名'] || '';
    tr.appendChild(tdName);

    const tdDan = document.createElement('td');
    tdDan.textContent = displayFinalRank(row.final_rank);
    tr.appendChild(tdDan);

    const tdBirth = document.createElement('td');
    tdBirth.textContent = row['生年月日'] || '';
    tr.appendChild(tdBirth);

    const td4 = document.createElement('td');
    td4.textContent = row['四段昇段日'] || '';
    tr.appendChild(td4);

    const td5 = document.createElement('td');
    td5.textContent = row['五段昇段日'] || '';
    tr.appendChild(td5);

    const td6 = document.createElement('td');
    td6.textContent = row['六段昇段日'] || '';
    tr.appendChild(td6);

    const td7 = document.createElement('td');
    td7.textContent = row['七段昇段日'] || '';
    tr.appendChild(td7);

    const td8 = document.createElement('td');
    td8.textContent = row['八段昇段日'] || '';
    tr.appendChild(td8);

    const td9 = document.createElement('td');
    td9.textContent = row['九段昇段日'] || '';
    tr.appendChild(td9);

    const tdStatus = document.createElement('td');
    tdStatus.textContent = displayStatus(row.status);
    tr.appendChild(tdStatus);

    const tdMetric = document.createElement('td');
    // 現在の並び替え項目を表示用に整形したいが、ここでは日数のままでもOK
    // 余裕があれば「◯年◯か月◯日」に変換する
    tdMetric.textContent = displayMetricValue(row);
    tr.appendChild(tdMetric);

    tbody.appendChild(tr);
  });
}

// -----------------------------------------
// 最終段位の表示
// -----------------------------------------
function displayFinalRank(code) {
  if (code === 'title') return '称号';
  if (code === '4d') return '四段';
  if (code === '5d') return '五段';
  if (code === '6d') return '六段';
  if (code === '7d') return '七段';
  if (code === '8d') return '八段';
  if (code === '9d') return '九段';
  return '';
}

// -----------------------------------------
// 状態の表示
// -----------------------------------------
function displayStatus(status) {
  if (status === 'active') return '現役';
  if (status === 'retired') return '引退';
  if (status === 'dead') return '故人';
  return '';
}

// -----------------------------------------
// 現在のソート項目を取得して、その値を表示する
// （シンプルに日数のまま出す）
// -----------------------------------------
function displayMetricValue(row) {
  const section = document.querySelector('section');
  if (!section) return '';
  const selects = section.querySelectorAll('select');
  const metric = selects[1].value;
  const v = row[metric];
  if (v === null || typeof v === 'undefined') return '';
  return v + '日';
}
</script>
</body>
</html>

