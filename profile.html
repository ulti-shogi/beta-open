<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>将棋の殿堂</title>
    <link rel="stylesheet" href="style.css?v=20251104-c">
</head>
<body>
<header>
<p><a href="https://ulti-shogi.github.io/beta-open/index.html">TOPページに戻る</a></>
</header>
  <main>
<!-- ✅ 検索UIは後回しなので最小だけ -->
<section>
  <p>棋士プロフィール一覧（並べ替え）</p>

  <!-- 並べ替え対象を選ぶと「表示する列」が切り替わる -->
  <label for="">並べ替え</label>
  <select name="">
    <option value="sekiji">席次</option>
    <option value="kishi-no">棋士番号</option>
    <option value="age">年齢（享年）</option>
    <option value="age-4d">四段昇段年齢</option>
    <option value="age-5d">五段昇段年齢</option>
    <option value="age-6d">六段昇段年齢</option>
    <option value="age-7d">七段昇段年齢</option>
    <option value="age-8d">八段昇段年齢</option>
    <option value="age-9d">九段昇段年齢</option>
    <option value="dur-4to5">四段→五段 昇段所要期間</option>
  </select>

  <!-- 昇順・降順（選んだだけで即反映） -->
  <p>並び順</p>
<label><input type="radio" name="order" value="keep" checked> 席次順</label>
<label><input type="radio" name="order" value="asc"> 昇順</label>
<label><input type="radio" name="order" value="desc"> 降順</label>
</section>

<table>
  <thead></thead>
  <tbody></tbody>
</table>

<div class="free">
  <h3>自由欄</h3>
  <p>補足情報など自由に書き込む。</p>
      </div>

  </main>
  <footer>フッター</footer>

<script>
// =======================================
// profile.html script（四→五 段 昇段“所要期間” 追加）
//
// 追加モード: value="dur-4to5"
// 表示列: 棋士名・四段昇段日・五段昇段日・所要期間(◯年◯か月◯日)
// 並び: ラジオ（keep/asc/desc）に準拠
// =======================================

const CSV_URL = 'profile.csv';

// 先頭あたりのユーティリティ群の近くに追加
function formatDateYY(str) {
  if (!str) return '';
  const m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return str; // 不正値はそのまま
  const yy = String(Number(m[1]) % 100).padStart(2, '0');
  return `${yy}/${m[2]}/${m[3]}`; // 例: 2016-10-01 → 16/10/01
}

// 今日（ローカル）
const today = (() => {
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
})();

// 席次順を“原本”として保持
let baseData = [];
let currentMode = 'sekiji';   // sekiji | kishi-no | age | age-4d..9d | dur-4to5
let currentOrder = 'keep';     // keep | asc | desc

fetch(CSV_URL)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);
    const enriched = rows.map(enrichRow);
    baseData = enriched.slice().sort((a, b) => toNumberSafe(a['席次']) - toNumberSafe(b['席次']));
    renderTable(baseData, 'sekiji');
    setupUI();
  })
  .catch(err => console.error('CSV読み込み失敗:', err));

// ---------- CSV ----------
function parseCSV(csvText) {
  const lines = csvText.trim().split(/\r?\n/);
  if (!lines.length) return [];
  const header = lines[0].split(',').map(h => h.trim());
  const out = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const cols = lines[i].split(',');
    const row = {};
    header.forEach((h, idx) => row[h] = (cols[idx] || '').trim());
    out.push(row);
  }
  return out;
}

// ---------- 行の拡張 ----------
function enrichRow(row) {
  // 段位/称号
  const title = (row['称号'] || '').trim();
  const dan   = (row['段位'] || '').trim();
  const danOrTitle = title ? title : (dan || '');

  // 生没と現在年齢
  const birth = toDateSafe(row['生年月日']);
  const died  = toDateSafe(row['没年月日']);
  const endDate = died ? died : today;

  let ageDays = null, ageDisplay = '';
  if (birth) {
    ageDays = diffDays(birth, endDate);
    const a = diffYMD(birth, endDate);
    ageDisplay = `${died ? '享年' : ''}${a.year}歳${a.month}か月${a.day}日`;
  }

  // 各段昇段日
  const p4 = toDateSafe(row['四段昇段日']);
  const p5 = toDateSafe(row['五段昇段日']);
  const p6 = toDateSafe(row['六段昇段日']);
  const p7 = toDateSafe(row['七段昇段日']);
  const p8 = toDateSafe(row['八段昇段日']);
  const p9 = toDateSafe(row['九段昇段日']);

  // 指定日までの年齢
  const ageAt = (to) => {
    if (!birth || !to) return { days: null, text: '' };
    const days = diffDays(birth, to);
    const a = diffYMD(birth, to);
    return { days, text: `${a.year}歳${a.month}か月${a.day}日` };
  };
  const a4 = ageAt(p4), a5 = ageAt(p5), a6 = ageAt(p6), a7 = ageAt(p7), a8 = ageAt(p8), a9 = ageAt(p9);

  // ★ 四→五 段の“所要期間”
  let dur45_days = null, dur45_text = '';
  if (p4 && p5) {
    dur45_days = diffDays(p4, p5);
    const d = diffYMD(p4, p5);
    dur45_text = `${d.year}年${d.month}か月${d.day}日`;
  }

  return Object.assign({}, row, {
    '__dan_or_title__': danOrTitle,
    '__age_days__': ageDays, '__age_display__': ageDisplay,
    '__age_at_4d_days__': a4.days, '__age_at_4d_display__': a4.text,
    '__age_at_5d_days__': a5.days, '__age_at_5d_display__': a5.text,
    '__age_at_6d_days__': a6.days, '__age_at_6d_display__': a6.text,
    '__age_at_7d_days__': a7.days, '__age_at_7d_display__': a7.text,
    '__age_at_8d_days__': a8.days, '__age_at_8d_display__': a8.text,
    '__age_at_9d_days__': a9.days, '__age_at_9d_display__': a9.text,
    '__dur_4to5_days__': dur45_days,
    '__dur_4to5_display__': dur45_text
  });
}

// ---------- 日付 ----------
function toDateSafe(str) {
  if (!str) return null;
  const m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  return new Date(+m[1], +m[2]-1, +m[3]); // ローカル
}
function diffDays(a, b) { if (!a || !b) return null; return Math.floor((b - a) / 86400000); }
function diffYMD(from, to) {
  let y1=from.getFullYear(), m1=from.getMonth(), d1=from.getDate();
  let y2=to.getFullYear(),   m2=to.getMonth(),   d2=to.getDate();
  let year=y2-y1, month=m2-m1, day=d2-d1;
  if (day<0){ const last=new Date(y2,m2,0).getDate(); day+=last; month--; }
  if (month<0){ month+=12; year--; }
  return {year,month,day};
}

// ---------- UI ----------
function setupUI() {
  const section = document.querySelector('section');
  if (!section) return;
  const sel = section.querySelector('select');
  const radios = section.querySelectorAll('input[type="radio"][name="order"]');

  sel.addEventListener('change', () => {
    currentMode = sel.value;
    if (currentOrder === 'keep') renderTable(baseData, currentMode);
    else renderTable(sortData(baseData, currentMode, currentOrder), currentMode);
  });

  radios.forEach(r => {
    r.addEventListener('change', () => {
      if (!r.checked) return;
      currentOrder = r.value; // keep/asc/desc
      if (currentOrder === 'keep') renderTable(baseData, currentMode);
      else renderTable(sortData(baseData, currentMode, currentOrder), currentMode);
    });
  });
}

// ---------- 並び替え ----------
function sortData(data, mode, order) {
  const copied = data.slice();
  const dir = (order === 'desc') ? -1 : 1;

  if (mode === 'kishi-no') {
    copied.sort((a,b)=>(toNumberSafe(a['棋士番号'])-toNumberSafe(b['棋士番号']))*dir);
  } else if (mode === 'age') {
    copied.sort((a,b)=>numCmp(a['__age_days__'], b['__age_days__']) * dir);
  } else if (/^age-[4-9]d$/.test(mode)) {
    const key = mode.replace('age-','__age_at_') + '_days__';
    copied.sort((a,b)=>numCmp(a[key], b[key]) * dir);
  } else if (mode === 'dur-4to5') {
    copied.sort((a,b)=>numCmp(a['__dur_4to5_days__'], b['__dur_4to5_days__']) * dir);
  } else {
    copied.sort((a,b)=>(toNumberSafe(a['席次'])-toNumberSafe(b['席次']))*dir);
  }
  return copied;
}
function numCmp(a,b){ const an=a==null, bn=b==null; if(an&&bn) return 0; if(an) return 1; if(bn) return -1; return a-b; }
function toNumberSafe(v){ const n=Number(v); return isNaN(n) ? 9999999 : n; }

// ---------- 描画 ----------
function renderTable(rows, mode) {
  const table = document.querySelector('table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  let cols;
  if (mode === 'age') {
    cols = [
      { key:'区分', label:'区分' },
      { key:'棋士名', label:'棋士名' },
      { key:'__age_display__', label:'年齢' },
      { key:'生年月日', label:'生年月日' }
    ];
  } else if (mode === 'kishi-no') {
    cols = [
      { key:'区分', label:'区分' },
      { key:'棋士番号', label:'棋士番号' },
      { key:'棋士名', label:'棋士名' },
      { key:'__dan_or_title__', label:'段位/称号' }
    ];
  } else if (/^age-[4-9]d$/.test(mode)) {
    const rankMap = {
      'age-4d': { label:'四段昇段年齢', dateCol:'四段昇段日', displayKey:'__age_at_4d_display__' },
      'age-5d': { label:'五段昇段年齢', dateCol:'五段昇段日', displayKey:'__age_at_5d_display__' },
      'age-6d': { label:'六段昇段年齢', dateCol:'六段昇段日', displayKey:'__age_at_6d_display__' },
      'age-7d': { label:'七段昇段年齢', dateCol:'七段昇段日', displayKey:'__age_at_7d_display__' },
      'age-8d': { label:'八段昇段年齢', dateCol:'八段昇段日', displayKey:'__age_at_8d_display__' },
      'age-9d': { label:'九段昇段年齢', dateCol:'九段昇段日', displayKey:'__age_at_9d_display__' }
    };
    const cfg = rankMap[mode];
    cols = [
      { key:'区分', label:'区分' },
      { key:'棋士名', label:'棋士名' },
      { key:cfg.displayKey, label:cfg.label },
      { key:cfg.dateCol, label:cfg.dateCol }
    ];
  } else if (mode === 'dur-4to5') {
    cols = [
      { key:'棋士名', label:'棋士名' },
      { key:'四段昇段日', label:'四段' },
      { key:'五段昇段日', label:'五段' },
      { key:'__dur_4to5_display__', label:'所要期間' }
    ];
  } else {
    cols = [
      { key:'区分', label:'区分' },
      { key:'席次', label:'席次' },
      { key:'棋士名', label:'棋士名' },
      { key:'__dan_or_title__', label:'段位/称号' }
    ];
  }

  // thead
  thead.innerHTML = '';
  const trh = document.createElement('tr');
  cols.forEach(c => { const th=document.createElement('th'); th.textContent=c.label; trh.appendChild(th); });
  thead.appendChild(trh);

  // tbody
  tbody.innerHTML = '';
  rows.forEach(row => {
  const tr = document.createElement('tr');
  cols.forEach(c => {
    const td = document.createElement('td');
    let val = row[c.key] || '';

    // ★ 四→五モードのときだけ日付を短縮表示
    if (mode === 'dur-4to5' && (c.key === '四段昇段日' || c.key === '五段昇段日')) {
      val = formatDateYY(val);
    }

    td.textContent = val;
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
});
}
</script>
</body>
</html>

