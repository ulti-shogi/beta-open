<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>将棋の殿堂</title>
    <link rel="stylesheet" href="style.css?v=20251104-a">
</head>
<body>
<header>
<p><a href="https://ulti-shogi.github.io/beta-open/index.html">TOPページに戻る</a></>
</header>
  <main>
<!-- ✅ 検索UIは後回しなので最小だけ -->
<section>
  <p>棋士プロフィール一覧（並べ替え）</p>

  <!-- 並べ替え対象を選ぶと「表示する列」が切り替わる -->
  <label for="">並べ替え</label>
  <select name="">
    <option value="sekiji">席次</option>
    <option value="kishi-no">棋士番号</option>
    <option value="age">年齢（享年）</option>
    <option value="age-4d">四段昇段年齢</option>
    <option value="age-5d">五段昇段年齢</option>
    <option value="age-6d">六段昇段年齢</option>
    <option value="age-7d">七段昇段年齢</option>
    <option value="age-8d">八段昇段年齢</option>
    <option value="age-9d">九段昇段年齢</option>
  </select>

  <!-- 昇順・降順（選んだだけで即反映） -->
  <p>並び順</p>
<label><input type="radio" name="order" value="keep" checked> 席次順</label>
<label><input type="radio" name="order" value="asc"> 昇順</label>
<label><input type="radio" name="order" value="desc"> 降順</label>
</section>

<table>
  <thead></thead>
  <tbody></tbody>
</table>

<div class="free">
  <h3>自由欄</h3>
  <p>補足情報など自由に書き込む。</p>
      </div>

  </main>
  <footer>フッター</footer>

<script>
// =======================================
// profile.html script（四〜九段 昇段年齢モード 追加版）
//
// セレクト値：
//  - sekiji      … 区分・席次・棋士名・段位/称号
//  - kishi-no    … 区分・棋士番号・棋士名・段位/称号
//  - age         … 区分・棋士名・年齢（享年含む）・生年月日
//  - age-4d..9d  … 区分・棋士名・◯段昇段年齢・◯段昇段日
//
// ラジオ(name="order")：keep | asc | desc
//  - keep … 席次順のまま（セレクト切替しても席次順維持・列だけ切替）
//  - asc/desc … セレクトで選んだ指標で並び替え
// =======================================

const CSV_URL = 'profile.csv';

// 今日（ローカル）
const today = (() => {
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
})();

// 席次順で固定保持する“原本”
let baseData = [];

// 現在のモード（セレクト）
let currentMode = 'sekiji';
// 現在の並び（ラジオ）
let currentOrder = 'keep';

// ---- 初期化 ----
fetch(CSV_URL)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);
    const enriched = rows.map(r => enrichRow(r));
    baseData = enriched.slice().sort((a, b) => toNumberSafe(a['席次']) - toNumberSafe(b['席次']));
    renderTable(baseData, 'sekiji');
    setupUI();
  })
  .catch(err => console.error('CSV読み込み失敗:', err));

// -------------------------
// CSV → 配列（列名で参照）
// -------------------------
function parseCSV(csvText) {
  const lines = csvText.trim().split(/\r?\n/);
  if (!lines.length) return [];
  const header = lines[0].split(',').map(h => h.trim());
  const out = [];
  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const cols = lines[i].split(',');
    const row = {};
    header.forEach((h, idx) => {
      row[h] = (cols[idx] || '').trim();
    });
    out.push(row);
  }
  return out;
}

// -------------------------
// 行の拡張：段位/称号 + 年齢 + 各段昇段年齢（四〜九）
// 生成キー：
//  __dan_or_title__
//  __age_days__, __age_display__
//  __age_at_4d_days__/display__ 〜 __age_at_9d_days__/display__
// -------------------------
function enrichRow(row) {
  // 段位/称号
  const title = (row['称号'] || '').trim();
  const dan = (row['段位'] || '').trim();
  const danOrTitle = title ? title : dan ? dan : '';

  // 生年月日・没年月日
  const birth = toDateSafe(row['生年月日']);
  const died  = toDateSafe(row['没年月日']);
  const endDate = died ? died : today;

  // 現在の年齢/享年
  let ageDays = null, ageDisplay = '';
  if (birth) {
    ageDays = diffDays(birth, endDate);
    const { year, month, day } = diffYMD(birth, endDate);
    const label = died ? '享年' : '';
    ageDisplay = `${label}${year}歳${month}か月${day}日`;
  }

  // 段ごとの昇段日
  const p4 = toDateSafe(row['四段昇段日']);
  const p5 = toDateSafe(row['五段昇段日']);
  const p6 = toDateSafe(row['六段昇段日']);
  const p7 = toDateSafe(row['七段昇段日']);
  const p8 = toDateSafe(row['八段昇段日']);
  const p9 = toDateSafe(row['九段昇段日']);

  // 各段昇段年齢を生成する小関数
  const makeAgeAt = (toDate) => {
    if (!birth || !toDate) return { days: null, text: '' };
    const days = diffDays(birth, toDate);
    const { year, month, day } = diffYMD(birth, toDate);
    return { days, text: `${year}歳${month}か月${day}日` };
  };

  const a4 = makeAgeAt(p4);
  const a5 = makeAgeAt(p5);
  const a6 = makeAgeAt(p6);
  const a7 = makeAgeAt(p7);
  const a8 = makeAgeAt(p8);
  const a9 = makeAgeAt(p9);

  return Object.assign({}, row, {
    '__dan_or_title__': danOrTitle,
    '__age_days__': ageDays,
    '__age_display__': ageDisplay,
    '__age_at_4d_days__': a4.days, '__age_at_4d_display__': a4.text,
    '__age_at_5d_days__': a5.days, '__age_at_5d_display__': a5.text,
    '__age_at_6d_days__': a6.days, '__age_at_6d_display__': a6.text,
    '__age_at_7d_days__': a7.days, '__age_at_7d_display__': a7.text,
    '__age_at_8d_days__': a8.days, '__age_at_8d_display__': a8.text,
    '__age_at_9d_days__': a9.days, '__age_at_9d_display__': a9.text
  });
}

// -------------------------
// 日付ユーティリティ（ローカル基準）
// -------------------------
function toDateSafe(str) {
  if (!str) return null;
  const m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  return new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
}

function diffDays(a, b) {
  if (!a || !b) return null;
  return Math.floor((b.getTime() - a.getTime()) / 86400000);
}

function diffYMD(from, to) {
  let y1 = from.getFullYear(), m1 = from.getMonth(), d1 = from.getDate();
  let y2 = to.getFullYear(),   m2 = to.getMonth(),   d2 = to.getDate();

  let year = y2 - y1;
  let month = m2 - m1;
  let day = d2 - d1;

  if (day < 0) {
    const prevMonthLast = new Date(y2, m2, 0).getDate();
    day += prevMonthLast;
    month--;
  }
  if (month < 0) {
    month += 12;
    year--;
  }
  return { year, month, day };
}

// -------------------------
// UIイベント
// -------------------------
function setupUI() {
  const section = document.querySelector('section');
  if (!section) return;

  const sel = section.querySelector('select');
  const radios = section.querySelectorAll('input[type="radio"][name="order"]');

  // セレクト切替：列のみ切替。ラジオがasc/descなら並び替えも適用。
  sel.addEventListener('change', () => {
    currentMode = sel.value; // sekiji | kishi-no | age | age-4d..age-9d
    if (currentOrder === 'keep') {
      renderTable(baseData, currentMode);
    } else {
      const sorted = sortData(baseData, currentMode, currentOrder);
      renderTable(sorted, currentMode);
    }
  });

  // ラジオ切替：keepなら席次順に戻す／asc,descなら現在モードでソート
  radios.forEach(r => {
    r.addEventListener('change', () => {
      if (!r.checked) return;
      currentOrder = r.value; // keep | asc | desc
      if (currentOrder === 'keep') {
        renderTable(baseData, currentMode);
      } else {
        const sorted = sortData(baseData, currentMode, currentOrder);
        renderTable(sorted, currentMode);
      }
    });
  });
}

// -------------------------
// 並べ替え
// -------------------------
function sortData(data, mode, order) {
  const copied = data.slice();
  const dir = (order === 'desc') ? -1 : 1;

  if (mode === 'kishi-no') {
    copied.sort((a, b) => (toNumberSafe(a['棋士番号']) - toNumberSafe(b['棋士番号'])) * dir);
  } else if (mode === 'age') {
    copied.sort((a, b) => {
      const aa = a['__age_days__'], bb = b['__age_days__'];
      const aNull = (aa == null), bNull = (bb == null);
      if (aNull && bNull) return 0;
      if (aNull) return 1;
      if (bNull) return -1;
      return (aa - bb) * dir;
    });
  } else if (mode === 'age-4d' || mode === 'age-5d' || mode === 'age-6d' || mode === 'age-7d' || mode === 'age-8d' || mode === 'age-9d') {
    const key = mode.replace('age-', '__age_at_') + '_days__'; // 例: age-5d → __age_at_5d_days__
    copied.sort((a, b) => {
      const aa = a[key], bb = b[key];
      const aNull = (aa == null), bNull = (bb == null);
      if (aNull && bNull) return 0;
      if (aNull) return 1;
      if (bNull) return -1;
      return (aa - bb) * dir;
    });
  } else {
    // 席次
    copied.sort((a, b) => (toNumberSafe(a['席次']) - toNumberSafe(b['席次'])) * dir);
  }
  return copied;
}

function toNumberSafe(v) {
  const n = Number(v);
  if (isNaN(n)) return 9999999;
  return n;
}

// -------------------------
// テーブル描画（モード別に列を変える）
// -------------------------
function renderTable(rows, mode) {
  const table = document.querySelector('table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  let cols;

  if (mode === 'age') {
    cols = [
      { key: '区分', label: '区分' },
      { key: '棋士名', label: '棋士名' },
      { key: '__age_display__', label: '年齢' },
      { key: '生年月日', label: '生年月日' }
    ];
  } else if (mode === 'kishi-no') {
    cols = [
      { key: '区分', label: '区分' },
      { key: '棋士番号', label: '棋士番号' },
      { key: '棋士名', label: '棋士名' },
      { key: '__dan_or_title__', label: '段位/称号' }
    ];
  } else if (mode === 'age-4d' || mode === 'age-5d' || mode === 'age-6d' || mode === 'age-7d' || mode === 'age-8d' || mode === 'age-9d') {
    // ◯段昇段年齢モード（共通レイアウト）
    // ラベルと日付列名を段に応じて変える
    const rankMap = {
      'age-4d': { label: '四段昇段年齢', dateCol: '四段昇段日', displayKey: '__age_at_4d_display__' },
      'age-5d': { label: '五段昇段年齢', dateCol: '五段昇段日', displayKey: '__age_at_5d_display__' },
      'age-6d': { label: '六段昇段年齢', dateCol: '六段昇段日', displayKey: '__age_at_6d_display__' },
      'age-7d': { label: '七段昇段年齢', dateCol: '七段昇段日', displayKey: '__age_at_7d_display__' },
      'age-8d': { label: '八段昇段年齢', dateCol: '八段昇段日', displayKey: '__age_at_8d_display__' },
      'age-9d': { label: '九段昇段年齢', dateCol: '九段昇段日', displayKey: '__age_at_9d_display__' }
    };
    const cfg = rankMap[mode];
    cols = [
      { key: '区分', label: '区分' },
      { key: '棋士名', label: '棋士名' },
      { key: cfg.displayKey, label: cfg.label },
      { key: cfg.dateCol, label: cfg.dateCol }
    ];
  } else {
    // sekiji
    cols = [
      { key: '区分', label: '区分' },
      { key: '席次', label: '席次' },
      { key: '棋士名', label: '棋士名' },
      { key: '__dan_or_title__', label: '段位/称号' }
    ];
  }

  // thead
  thead.innerHTML = '';
  const trHead = document.createElement('tr');
  cols.forEach(c => {
    const th = document.createElement('th');
    th.textContent = c.label;
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  // tbody
  tbody.innerHTML = '';
  rows.forEach(row => {
    const tr = document.createElement('tr');
    cols.forEach(c => {
      const td = document.createElement('td');
      td.textContent = row[c.key] || '';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>

