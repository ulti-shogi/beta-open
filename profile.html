<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>将棋の殿堂</title>
    <link rel="stylesheet" href="style.css?v=20251102-f">
</head>
<body>
<header>
<p><a href="https://ulti-shogi.github.io/beta-open/index.html">TOPページに戻る</a></>
</header>
  <main>
<!-- ✅ 検索UIは後回しなので最小だけ -->
<section>
  <p>棋士プロフィール一覧（並べ替え）</p>

  <!-- 並べ替え対象 -->
  <label for="">並べ替え</label>
  <select name="">
    <option value="sekiji">席次の小さい順</option>
    <option value="kishi-no">棋士番号の小さい順</option>
    <option value="age">現在の年齢と享年</option>
  </select>

  <!-- 実行ボタン -->
  <p><button type="button">この順番で表示</button></p>
</section>

<!-- ✅ 初期表示テーブル（thead/tbodyだけ用意しておく） -->
<table>
  <thead></thead>
  <tbody></tbody>
</table>

<div class="free">
  <h3>自由欄</h3>
  <p>補足情報など自由に書き込む。</p>
      </div>

  </main>
  <footer>フッター</footer>

<script>
// =======================================
// profile.html 並べ替え＋「現在の年齢と享年」対応版
// 今あるセレクトに ①席次 ②棋士番号 ③現在の年齢と享年 を足す
// 選択肢が「現在の年齢と享年」のときだけ、表示カラムを
//    区分 / 棋士名 / 年齢 / 生年月日
// に切り替える
// ※ id/class は付けない（sectionに1つずつしかない前提）
// ※ CSV は列名で参照する
// =======================================

const CSV_URL = 'profile.csv';

// 初期表示（席次・棋士番号のとき）の4列
const INITIAL_COLUMNS = [
  { key: '区分', label: '区分' },
  { key: '棋士番号', label: '棋士番号' },
  { key: '棋士名', label: '棋士名' },
  { key: '__dan_or_title__', label: '段位/称号' }
];

// 「現在の年齢と享年」を選んだときの4列
const AGE_COLUMNS = [
  { key: '区分', label: '区分' },
  { key: '棋士名', label: '棋士名' },
  { key: '__age_display__', label: '年齢' },
  { key: '生年月日', label: '生年月日' }
];

// 読み込んだデータを保持
let profileData = [];

// 今日（年齢計算用）を固定
const today = (function() {
  const d = new Date();
  return new Date(d.getFullYear(), d.getMonth(), d.getDate());
})();

fetch(CSV_URL)
  .then(res => res.text())
  .then(text => {
    const rows = parseCSV(text);

    // 段位/称号と、年齢系の派生値を付与
    profileData = rows.map(r => enrichRow(r));

    // 初期表示：席次の小さい順
    const sorted = sortData(profileData, 'sekiji');
    renderTable(sorted, 'sekiji');

    // UIイベントをセット
    setupSortUI();
  })
  .catch(err => {
    console.error('CSVの読み込みに失敗しました', err);
  });


// ---------------------------------------
// CSV → オブジェクト配列
// ---------------------------------------
function parseCSV(csvText) {
  const lines = csvText.trim().split(/\r?\n/);
  if (!lines.length) return [];
  const header = lines[0].split(',').map(h => h.trim());
  const data = [];

  for (let i = 1; i < lines.length; i++) {
    if (!lines[i].trim()) continue;
    const cols = lines[i].split(',');
    const row = {};
    header.forEach((h, idx) => {
      row[h] = (cols[idx] || '').trim();
    });
    data.push(row);
  }
  return data;
}

// ---------------------------------------
// 行を拡張する：段位/称号 + 年齢(日数) + 表示用年齢文字列
// 年齢の仕様：
// ・没年月日があれば「享年」= 没 - 生
// ・なければ「現在の年齢」= 今日 - 生
// 表示は「◯歳◯か月◯日」まで算出
// ---------------------------------------
function enrichRow(row) {
  const title = (row['称号'] || '').trim();
  const dan = (row['段位'] || '').trim();
  const danOrTitle = title ? title : dan ? dan : '';

  const birth = toDateSafe(row['生年月日']);
  const died = toDateSafe(row['没年月日']);
  const endDate = died ? died : today;

  let ageDays = null;
  let ageDisplay = '';

  if (birth) {
    ageDays = diffDays(birth, endDate);

    // 年・月・日の差分を細かく計算
    const y1 = birth.getUTCFullYear();
    const m1 = birth.getUTCMonth();
    const d1 = birth.getUTCDate();

    const y2 = endDate.getUTCFullYear();
    const m2 = endDate.getUTCMonth();
    const d2 = endDate.getUTCDate();

    let year = y2 - y1;
    let month = m2 - m1;
    let day = d2 - d1;

    if (day < 0) {
      // 前の月の日数を借りる
      const prevMonth = new Date(Date.UTC(y2, m2, 0));
      day += prevMonth.getUTCDate();
      month--;
    }
    if (month < 0) {
      month += 12;
      year--;
    }

    ageDisplay = `${year}歳${month}ヶ月${day}日`;
  }

  return Object.assign({}, row, {
    '__dan_or_title__': danOrTitle,
    '__age_days__': ageDays,
    '__age_display__': ageDisplay
  });
}

// ---------------------------------------
// 安全な日付変換
// ---------------------------------------
function toDateSafe(str) {
  if (!str) return null;
  const m = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (!m) return null;
  const y = Number(m[1]);
  const mo = Number(m[2]);
  const d = Number(m[3]);
  // UTCではなくローカル時間を使用（JST基準）
  return new Date(y, mo - 1, d);
}

// 日数差
function diffDays(start, end) {
  if (!start || !end) return null;
  const ms = end.getTime() - start.getTime();
  return Math.floor(ms / 86400000);
}

// ---------------------------------------
// 並べ替えUIのセット
// 既存の<select>に「現在の年齢と享年」を追加しておく
// ---------------------------------------
function setupSortUI() {
  const section = document.querySelector('section');
  if (!section) return;

  const sel = section.querySelector('select');
  const btn = section.querySelector('button');
  if (!sel || !btn) return;

  btn.addEventListener('click', () => {
    const mode = sel.value; // "sekiji" | "kishi-no" | "age"
    const sorted = sortData(profileData, mode);
    renderTable(sorted, mode);
  });
}

// ---------------------------------------
// 並べ替え
// ---------------------------------------
function sortData(data, mode) {
  const copied = data.slice();

  if (mode === 'kishi-no') {
    copied.sort((a, b) => {
      const na = toNumberSafe(a['棋士番号']);
      const nb = toNumberSafe(b['棋士番号']);
      return na - nb;
    });
  } else if (mode === 'age') {
    // 年齢（日数）の小さい順＝若い順
    copied.sort((a, b) => {
      const aa = a['__age_days__'];
      const bb = b['__age_days__'];
      const aNull = (aa === null || typeof aa === 'undefined');
      const bNull = (bb === null || typeof bb === 'undefined');

      if (aNull && bNull) return 0;
      if (aNull) return 1;  // 年齢が出ない人は後ろ
      if (bNull) return -1;

      return aa - bb;
    });
  } else {
    // デフォルト：席次の小さい順
    copied.sort((a, b) => {
      const sa = toNumberSafe(a['席次']);
      const sb = toNumberSafe(b['席次']);
      return sa - sb;
    });
  }

  return copied;
}

function toNumberSafe(v) {
  const num = Number(v);
  if (isNaN(num)) return 9999999;
  return num;
}

// ---------------------------------------
// テーブル描画
// mode によって表示する列セットを変える
// ---------------------------------------
function renderTable(rows, mode) {
  const table = document.querySelector('table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  // どの列を使うか決める
  const columns = (mode === 'age') ? AGE_COLUMNS : INITIAL_COLUMNS;

  // thead
  thead.innerHTML = '';
  const trHead = document.createElement('tr');
  columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col.label;
    trHead.appendChild(th);
  });
  thead.appendChild(trHead);

  // tbody
  tbody.innerHTML = '';
  rows.forEach(row => {
    const tr = document.createElement('tr');

    columns.forEach(col => {
      const td = document.createElement('td');
      td.textContent = row[col.key] || '';
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}
</script>
</body>
</html>

