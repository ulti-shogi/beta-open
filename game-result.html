<!doctype html>
<!-- no.8764 -->
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2025年度対局結果</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --accent:#2563eb;
      --danger:#b91c1c;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    html,body{
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",Helvetica,Arial,sans-serif;
    }

    .wrap{max-width:480px;margin:0 auto;padding:14px;}

    header{display:flex;align-items:center;gap:10px;margin:4px 0 12px;}
    header .logo{
      width:26px;height:26px;border-radius:6px;
      background:linear-gradient(135deg,var(--accent),#93c5fd);
    }
    header h1{font-size:18px;font-weight:700;margin:0;letter-spacing:.02em;}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.08);
      margin-bottom:12px;
    }

    .help{color:var(--muted);font-size:12px;line-height:1.5;margin:6px 0 0;}
    .row{display:flex;gap:10px;align-items:center;}

    input[type="text"]{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#ffffff;
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    input[type="text"]::placeholder{color:#9ca3af;}

    button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#f3f4f6;
      color:var(--text);
      font-weight:700;
      font-size:14px;
      white-space:nowrap;
    }
    button:active{transform:translateY(1px);}

    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;}
    .kpi > div{
      flex:1 1 120px;
      background:#f9fafb;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
    }
    .kpi .label{color:var(--muted);font-size:11px;font-weight:700;margin-bottom:4px;}
    .kpi .value{font-size:18px;font-weight:800;font-family:var(--mono);}
    .kpi .sub{color:var(--muted);font-size:11px;margin-top:2px;}

    table{width:100%;border-collapse:collapse;font-size:13px;}
    th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;vertical-align:top;}
    th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:center;vertical-align:top;}
    td.num{font-family:var(--mono);text-align:center;}
    td.badge{font-family:var(--mono);font-weight:800;}
    .muted{color:var(--muted);}

    .err{
      color:var(--danger);
      padding:10px;
      border:1px solid #fecaca;
      background:#fef2f2;
      border-radius:12px;
      margin-bottom:12px;
    }

    /* --- 列表示（デフォルト＝スマホ） --- */
    .col-phase, .col-so { display:none; }

    /* タブレット：進行(notes)を表示（5列） */
    @media (min-width: 600px){
      .wrap{max-width:720px;}
      .col-phase{ display:table-cell; }
    }

    /* PC：進行 + 千日手(start-over)を表示（6列） */
    @media (min-width: 900px){
      .wrap{max-width:980px;}
      .col-so{ display:table-cell; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <h1>日本将棋連盟2025年度対局結果</h1>
    </header>

    <section class="card">
      <div class="row">
        <input type="text" name="player" placeholder="棋士名を入力（例：藤井聡太）" autocomplete="off" />
        <button type="button" name="doSearch">検索</button>
      </div>
      <p class="help">このページは <span class="muted">2025-game-result.csv</span> を読み込み、棋士名に一致する対局を抽出して勝敗（○□=勝 / ●■=負）を集計します。</p>
    </section>

    <section class="card" data-role="summary" hidden>
      <div class="muted" data-role="headline" style="font-weight:800;"></div>
      <div class="kpi">
        <div>
          <div class="label">勝</div>
          <div class="value" data-role="wins">0</div>
          <div class="sub">○ / □</div>
        </div>
        <div>
          <div class="label">負</div>
          <div class="value" data-role="losses">0</div>
          <div class="sub">● / ■</div>
        </div>
        <div>
          <div class="label">対局</div>
          <div class="value" data-role="games">0</div>
          <div class="sub">勝＋負</div>
        </div>
        <div>
          <div class="label">勝率</div>
          <div class="value" data-role="rate">0.000</div>
          <div class="sub">勝/対局</div>
        </div>
      </div>
    </section>

    <section class="card" data-role="list" hidden>
      <div class="muted" style="font-weight:800;margin-bottom:8px;">
        対局一覧（<span data-role="count">0</span>件）
      </div>

      <table>
        <thead>
          <tr>
            <th>日付</th>
            <th>棋戦</th>
            <th class="col-phase">進行</th>
            <th>相手</th>
            <th class="num">勝敗</th>
            <th class="col-so">千日手</th>
          </tr>
        </thead>
        <tbody data-role="tbody"></tbody>
      </table>

      <p class="help">※「勝敗」は検索した棋士の視点です。</p>
    </section>
  </div>

<script>
const CSV_URL = '2025-game-result.csv';

const WIN = new Set(['○','□']);
const LOSE = new Set(['●','■']);

function parseCSV(text){
  const rows = [];
  let cur = '', row = [], inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') {
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
      else { inQuotes = !inQuotes; }
    } else if (ch === ',' && !inQuotes) {
      row.push(cur); cur = '';
    } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
      if (cur !== '' || row.length > 0) {
        row.push(cur);
        rows.push(row);
      }
      if (ch === '\r' && text[i+1] === '\n') i++;
      cur = ''; row = [];
    } else {
      cur += ch;
    }
  }
  if (cur !== '' || row.length > 0) {
    row.push(cur);
    rows.push(row);
  }
  return rows;
}

function norm(v){
  return String(v ?? '').trim();
}

function judge(sym){
  const s = norm(sym);
  if (WIN.has(s)) return 'W';
  if (LOSE.has(s)) return 'L';
  return '';
}

/* YYYY-MM-DD 専用（表記ゆれ対策なし） */
function dateKey(s){
  const [y,m,d] = s.split('-').map(Number);
  return new Date(y, m - 1, d).getTime();
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

let DATA = null;

async function loadCSV(){
  const res = await fetch(CSV_URL, { cache: 'no-store' });
  if (!res.ok) throw new Error('CSVを取得できませんでした');

  const text = await res.text();
  const rows = parseCSV(text).filter(r => r.some(c => norm(c) !== ''));
  if (!rows.length) throw new Error('CSVが空です');

  const headers = rows[0].map(norm);
  const body = rows.slice(1);

  const idx = name => headers.indexOf(name);

  const required = [
    'game-date',
    'match',
    'result-1',
    'first-player',
    'second-player',
    'result-2'
  ];

  for (const col of required) {
    if (idx(col) < 0) {
      throw new Error(`必要な列が見つかりません: ${col}`);
    }
  }

  DATA = {
    body,
    idxDate: idx('game-date'),
    idxMatch: idx('match'),
    idxNotes: idx('notes'),
    idxR1: idx('result-1'),
    idxP1: idx('first-player'),
    idxP2: idx('second-player'),
    idxR2: idx('result-2'),
    idxSO: idx('start-over')
  };
}

function searchPlayer(name){
  const q = norm(name);
  if (!q) return null;

  const {
    body, idxDate, idxMatch, idxNotes,
    idxR1, idxP1, idxP2, idxR2, idxSO
  } = DATA;

  const matches = [];
  let wins = 0, losses = 0;

  for (const r of body) {
    const p1 = norm(r[idxP1]);
    const p2 = norm(r[idxP2]);
    if (p1 !== q && p2 !== q) continue;

    let wl = '';
    let opp = '';

    if (p1 === q) {
      wl = judge(r[idxR1]);
      opp = p2;
    } else {
      wl = judge(r[idxR2]);
      opp = p1;
    }

    if (wl === 'W') wins++;
    if (wl === 'L') losses++;

    matches.push({
      date: norm(r[idxDate]),
      match: norm(r[idxMatch]),
      notes: idxNotes >= 0 ? norm(r[idxNotes]) : '',
      startOver: idxSO >= 0 ? norm(r[idxSO]) : '',
      opp,
      wl
    });
  }

  /* 日付が浅い順（古い → 新しい） */
  matches.sort((a, b) => dateKey(a.date) - dateKey(b.date));

  return { name: q, matches, wins, losses };
}

function render(result){
  const summary = document.querySelector('[data-role="summary"]');
  const list = document.querySelector('[data-role="list"]');
  const tbody = document.querySelector('[data-role="tbody"]');

  if (!result) {
    summary.hidden = true;
    list.hidden = true;
    tbody.innerHTML = '';
    return;
  }

  const games = result.wins + result.losses;
  const rate = games ? (result.wins / games) : 0;

  document.querySelector('[data-role="headline"]').textContent = result.name;
  document.querySelector('[data-role="wins"]').textContent = result.wins;
  document.querySelector('[data-role="losses"]').textContent = result.losses;
  document.querySelector('[data-role="games"]').textContent = games;
  document.querySelector('[data-role="rate"]').textContent = rate.toFixed(3);
  document.querySelector('[data-role="count"]').textContent = result.matches.length;

  tbody.innerHTML = result.matches.map(x => {
    const badge = x.wl === 'W' ? '○' : (x.wl === 'L' ? '●' : '—');
    return `<tr>
      <td>${escapeHtml(x.date)}</td>
      <td>${escapeHtml(x.match)}</td>
      <td class="col-phase">${escapeHtml(x.notes)}</td>
      <td>${escapeHtml(x.opp)}</td>
      <td class="num">${badge}</td>
      <td class="col-so">${escapeHtml(x.startOver)}</td>
    </tr>`;
  }).join('');

  summary.hidden = false;
  list.hidden = false;
}

function wire(){
  const input = document.querySelector('input[name="player"]');
  const btn = document.querySelector('button[name="doSearch"]');

  const run = () => {
    if (!DATA) return;
    render(searchPlayer(input.value));
  };

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') run();
  });
  btn.addEventListener('click', run);
}

(async function(){
  try{
    await loadCSV();
    wire();
  }catch(err){
    alert(err.message);
  }
})();
</script>
</body>
</html>